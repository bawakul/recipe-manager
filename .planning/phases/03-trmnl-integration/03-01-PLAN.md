---
phase: 03-trmnl-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.ts
  - src/trmnl.ts
  - src/types.ts
autonomous: true
user_setup:
  - service: trmnl
    why: "E-ink display webhook integration"
    env_vars:
      - name: TRMNL_WEBHOOK_URL
        source: "TRMNL Dashboard > Private Plugins > Create plugin > Save > Copy webhook URL"
    dashboard_config:
      - task: "Create private plugin and paste Liquid template"
        location: "TRMNL Dashboard > Private Plugins > Edit plugin > Markup tab"

must_haves:
  truths:
    - "Parse API can push recipe to TRMNL display automatically"
    - "Manual endpoint can push any recipe to TRMNL on demand"
    - "Payload stays under 2kb limit via compression"
    - "TRMNL failures return success with warning (parse never fails)"
    - "Rate limit (429) is caught and reported as warning"
  artifacts:
    - path: "src/trmnl.ts"
      provides: "TRMNL payload formatting and push logic"
      exports: ["formatForTrmnl", "pushToTrmnl"]
    - path: "src/index.ts"
      provides: "API endpoints with TRMNL integration"
      contains: "/api/trmnl/push"
    - path: "src/types.ts"
      provides: "Extended Env type with TRMNL_WEBHOOK_URL"
      contains: "TRMNL_WEBHOOK_URL"
  key_links:
    - from: "src/index.ts"
      to: "src/trmnl.ts"
      via: "import pushToTrmnl"
      pattern: "import.*pushToTrmnl.*from.*trmnl"
    - from: "src/trmnl.ts"
      to: "env.TRMNL_WEBHOOK_URL"
      via: "fetch POST"
      pattern: "fetch\\(env\\.TRMNL_WEBHOOK_URL"
---

<objective>
Add TRMNL e-ink display integration to the recipe API

Purpose: Enable recipes to be pushed to TRMNL display automatically after parsing or manually on demand, fulfilling the hackathon's e-ink display goal.

Output: Two functional endpoints - enhanced `/api/recipe/parse` with auto-push and new `/api/trmnl/push` for manual triggers. TRMNL module handles payload formatting, size validation, and error handling.
</objective>

<execution_context>
@/Users/bharadwajkulkarni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bharadwajkulkarni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-trmnl-integration/03-CONTEXT.md
@.planning/phases/03-trmnl-integration/03-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

@src/index.ts
@src/types.ts
@src/claude.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TRMNL module with payload formatting and push logic</name>
  <files>src/trmnl.ts, src/types.ts</files>
  <action>
Create src/trmnl.ts with:

1. `formatForTrmnl(recipe: Recipe)` function:
   - Transform recipe to TRMNL merge_variables format
   - Structure: `{ merge_variables: { recipe_title, sections: [{name, steps}], step_count, truncated } }`
   - Remove ingredients (per CONTEXT.md - they're implied in steps)
   - Truncate title to 40 chars, each step to 80 chars
   - If total step count > 10, keep first 10 steps (distribute across sections)

2. `measurePayload(obj)` helper:
   - Use `new TextEncoder().encode(JSON.stringify(obj)).length` for accurate byte count
   - Return `{ serialized: string, bytes: number }`

3. `compressPayload(payload)` function:
   - If payload > 2048 bytes, progressively truncate:
     a. First, shorten step text to 60 chars
     b. If still too large, reduce to 8 steps total
     c. If still too large, reduce to 6 steps total
   - Set `truncated: true` flag when compression applied
   - Log payload size before/after for debugging

4. `pushToTrmnl(recipe: Recipe, env: Env)` function:
   - Format recipe with formatForTrmnl
   - Compress with compressPayload if needed
   - POST to env.TRMNL_WEBHOOK_URL with Content-Type: application/json
   - Return `{ success: true, trmnl_pushed: true }` on success
   - Return `{ success: true, warnings: [...] }` on 429 (rate limit)
   - Return `{ success: true, warnings: [...] }` on any other failure
   - Never throw - always return success with optional warnings
   - Handle missing TRMNL_WEBHOOK_URL gracefully (return warning, not error)

Update src/types.ts:
- Add TRMNL_WEBHOOK_URL to Env interface (optional with `?` since not all deployments need it)

Key patterns from RESEARCH.md:
- merge_variables wrapper is required (Liquid templates get direct variable access)
- Content-Type header required or webhook silently fails
- Use TextEncoder for accurate UTF-8 byte count (not string.length)
  </action>
  <verify>
TypeScript compiles: `cd "/Users/bharadwajkulkarni/Documents /Bawa's Lab/recipe-manager" && npx tsc --noEmit`
  </verify>
  <done>
src/trmnl.ts exports formatForTrmnl, measurePayload, compressPayload, and pushToTrmnl functions. Env type includes optional TRMNL_WEBHOOK_URL. All functions handle edge cases gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate TRMNL into Worker endpoints</name>
  <files>src/index.ts</files>
  <action>
Modify src/index.ts to:

1. Add route: POST /api/trmnl/push
   - Accept JSON body: `{ recipe: Recipe }`
   - Call pushToTrmnl(recipe, env)
   - Return the result (success + trmnl_pushed or success + warnings)
   - Validate recipe has required fields (title, sections)

2. Modify handleParse to auto-push after successful parse:
   - After recipe is parsed successfully, call pushToTrmnl(recipe, env)
   - Merge TRMNL result into response:
     - If trmnl_pushed: true, add to response
     - If warnings array exists, add to response
   - Parse response format: `{ title, sections, ingredients, trmnl_pushed?, warnings? }`
   - TRMNL push is fire-and-forget for error purposes - parse always succeeds if Claude succeeded

3. Update CORS headers:
   - Already allows POST, no changes needed

4. Add new route handler:
```typescript
if (url.pathname === '/api/trmnl/push' && request.method === 'POST') {
  return handleTrmnlPush(request, env);
}
```

Error handling per CONTEXT.md:
- TRMNL failure = return success with warning (recipe still parsed)
- Rate limit (429) = return success with warning
- Missing webhook URL = return success with warning (graceful degradation)
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Worker starts: `npm run dev` (should start without errors)
3. Parse endpoint returns recipe with trmnl_pushed or warnings field
  </verify>
  <done>
Worker has /api/trmnl/push endpoint for manual triggers. Parse endpoint auto-pushes to TRMNL after successful parse. Both endpoints return appropriate trmnl_pushed/warnings fields. TRMNL failures never cause parse failures.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript compilation passes**
   ```bash
   npx tsc --noEmit
   ```

2. **Worker starts locally**
   ```bash
   npm run dev
   # Should see "Ready on http://localhost:8787"
   ```

3. **Parse endpoint includes TRMNL fields** (test without TRMNL_WEBHOOK_URL set)
   ```bash
   curl -X POST http://localhost:8787/api/recipe/parse \
     -H "Content-Type: application/json" \
     -d '{"transcript": "Okay so I am going to make chicken wraps. I have some chicken breasts, tortillas, lettuce, and cheese. First dice the chicken. Then season with salt and pepper. Cook the chicken in a pan for about 5 minutes. Warm the tortillas. Assemble with lettuce and cheese."}'
   ```
   Expected: Response includes `warnings: ["TRMNL webhook URL not configured..."]`

4. **Manual push endpoint exists** (test without TRMNL_WEBHOOK_URL set)
   ```bash
   curl -X POST http://localhost:8787/api/trmnl/push \
     -H "Content-Type: application/json" \
     -d '{"recipe": {"title": "Test", "sections": [{"name": "Prep", "steps": [{"id": "step-1", "text": "Test step", "completed": false}]}], "ingredients": []}}'
   ```
   Expected: Response includes `warnings` about missing webhook URL

5. **Payload size validation** (manual test in code)
   - formatForTrmnl should produce payload < 2048 bytes for typical recipes
   - compressPayload should reduce oversized payloads
</verification>

<success_criteria>
- [ ] src/trmnl.ts created with formatForTrmnl, measurePayload, compressPayload, pushToTrmnl
- [ ] src/types.ts updated with optional TRMNL_WEBHOOK_URL in Env
- [ ] src/index.ts has /api/trmnl/push endpoint
- [ ] Parse endpoint auto-pushes to TRMNL and includes result in response
- [ ] All TRMNL failures return success with warnings (never fail the parse)
- [ ] Payload compression keeps data under 2kb limit
- [ ] TypeScript compiles without errors
- [ ] Worker starts successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-trmnl-integration/03-01-SUMMARY.md` using the summary template.
</output>
